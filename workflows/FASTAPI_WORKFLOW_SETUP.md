xa# N8N Workflow Setup for FastAPI Backend

## Overview
This workflow processes Gmail attachments with keyword filtering (KMRL) and sends them to the FastAPI backend for:
1. Document storage in MinIO
2. Content parsing
3. Embedding generation
4. RAG-based department classification
5. Summary generation

## Workflow Steps

### 1. Gmail Trigger - KMRL
- **Type**: Gmail Trigger
- **Configuration**:
  - Poll emails every minute
  - Filter by label: `KMRL`
  - Download attachments: Enabled

### 2. Filter - Has Attachments
- **Type**: IF condition
- **Logic**: Check if email has attachments
- If YES → Extract Attachments
- If NO → No Attachments (log and skip)

### 3. Extract Attachments
- **Type**: Code (JavaScript)
- **Purpose**: Extract all attachments from email
- **Output**: Array of attachment objects with metadata

### 4. Send to FastAPI Backend
- **Type**: HTTP Request
- **Method**: POST
- **URL**: `http://fastapi:8000/api/webhook/n8n`
- **Body Parameters**:
  - `filename`: Attachment filename
  - `content`: Base64 encoded file content
  - `content_type`: MIME type
  - `source`: "gmail"
  - `metadata`: Email metadata (subject, from, date, etc.)

### 5. Log Processing Results
- **Type**: Code (JavaScript)
- **Purpose**: Log FastAPI response with classification results

### 6. Final Processing
- **Type**: Code (JavaScript)
- **Purpose**: Format final output and optional notifications

## Import Instructions

1. **Open N8N**: Navigate to http://localhost:5678
2. **Import Workflow**:
   - Click "Import from File"
   - Select `fastapi-gmail-processor.json`
3. **Configure Gmail OAuth**:
   - Add Gmail OAuth2 credentials
   - Authorize with your Google account
4. **Create KMRL Label**:
   - In Gmail, create a label named "KMRL"
   - Set up filter: Emails containing "KMRL" → Apply label
5. **Activate Workflow**:
   - Toggle "Active" in N8N

## Testing

### Test with Sample Email
1. Send email to your Gmail with "KMRL" in subject
2. Attach a document (PDF, DOCX, Excel, etc.)
3. Email should be labeled with "KMRL"
4. N8N will process within 1 minute

### Expected Output
```json
{
  "status": "success",
  "document_id": "uuid-string",
  "department": "Finance|HR|Operations|etc",
  "summary": "Document summary generated by LLM",
  "object_path": "uuid.extension"
}
```

## Gmail Keyword Filtering

### Method 1: Gmail Label Filter
1. In Gmail → Settings → Filters and Blocked Addresses
2. Create filter:
   - **From**: Contains keywords (e.g., "KMRL", "official", etc.)
   - **OR Subject**: Contains keywords
   - **Action**: Apply label "KMRL"

### Method 2: Advanced Filter (Multiple Keywords)
```
subject:(KMRL OR invoice OR report OR contract)
OR from:(official@kmrl.com)
```

### Method 3: Department-Specific Labels
Create multiple workflows for different departments:
- Label: `KMRL-Finance` → Finance documents
- Label: `KMRL-HR` → HR documents
- Label: `KMRL-Operations` → Operations documents

## Monitoring

### N8N Execution Logs
- View: N8N Dashboard → Executions
- Shows: Success/failure status for each email processed

### FastAPI Logs
```bash
docker logs -f fastapi_backend
```

### Check MinIO Storage
- Open: http://localhost:9001
- Login: minioadmin / minioadmin123
- Browse bucket: `documents`

### Check Database
- Query Supabase to see stored metadata
- Verify embeddings in ChromaDB

## Troubleshooting

### Workflow Not Triggering
- Check Gmail label exists and is spelled correctly
- Verify OAuth credentials are valid
- Check N8N logs for errors

### Attachments Not Processing
- Verify attachment types are supported
- Check FastAPI logs for parsing errors
- Ensure MinIO is running

### Classification Issues
- Verify OPENAI_API_KEY is set
- Check API quota/limits
- Review department classifier prompts

## Environment Variables Required

In `.env` file:
```env
# Supabase
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key

# MinIO (already in docker-compose)
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin123
```
